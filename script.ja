package com.example.demo;

import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.client.RestTemplate;

import java.util.HashMap;
import java.util.Map;

@RestController
public class PlayerController {

    private static final String LIKE_API_URL = "https://mahmoud-aheqh0b3csgagdf4.centralus-01.azurewebsites.net/request?api_key=mahmoud7532000&id=%s&type=likes";
    private static final String VISITOR_API_URL = "https://xaz-ff-free-api-ird6.onrender.com/visut_api/%s";
    private static final String API_URL = "https://xaz222-mc03.onrender.com/get_player_info/";

    private Map<String, Long> lastLikeTime = new HashMap<>();

    @GetMapping("/")
    public ModelAndView index() {
        return new ModelAndView("index");
    }

    @PostMapping("/send_like")
    public String sendLike(@RequestParam String uid) {
        if (validateUid(uid)) {
            String playerInfo = fetchPlayerInfo(uid);
            if (playerInfo != null) {
                if (canLike(uid)) {
                    String response = new RestTemplate().getForObject(String.format(LIKE_API_URL, uid), String.class);
                    return handleLikeResponse(response, uid, playerInfo);
                } else {
                    return "Ù‡Ø°Ø§ Ø§Ù„Ù€ ID ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„Ø§ÙŠÙƒØ§Øª Ù„Ù‡ Ù…Ø¤Ø®Ø±Ù‹Ø§. ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 24 Ø³Ø§Ø¹Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                }
            } else {
                return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ UID.";
            }
        } else {
            return "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ UID ØµØ­ÙŠØ­.";
        }
    }

    @PostMapping("/send_visit")
    public String sendVisit(@RequestParam String uid) {
        if (validateUid(uid)) {
            String playerInfo = fetchPlayerInfo(uid);
            if (playerInfo != null) {
                String response = new RestTemplate().getForObject(String.format(VISITOR_API_URL, uid), String.class);
                return handleVisitResponse(response, uid, playerInfo);
            } else {
                return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ UID.";
            }
        } else {
            return "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ UID ØµØ­ÙŠØ­.";
        }
    }

    private boolean validateUid(String uid) {
        return uid.matches("\\d{8,12}");
    }

    private String fetchPlayerInfo(String uid) {
        RestTemplate restTemplate = new RestTemplate();
        try {
            return restTemplate.getForObject(API_URL + uid, String.class);
        } catch (Exception e) {
            return null;
        }
    }

    private boolean canLike(String uid) {
        long currentTime = System.currentTimeMillis() / 1000;
        return !lastLikeTime.containsKey(uid) || (currentTime - lastLikeTime.get(uid)) >= 86400;
    }

    private String handleLikeResponse(String response, String uid, String playerInfo) {
        if (response != null) {
            lastLikeTime.put(uid, System.currentTimeMillis() / 1000);
            return String.format("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø¥Ù„Ù‰ UID: %s Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰<br>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨: %s<br>", uid, playerInfo);
        } else {
            return String.format("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø¥Ù„Ù‰ UID: %s. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.", uid);
        }
    }

    private String handleVisitResponse(String response, String uid, String playerInfo) {
        if (response != null) {
            return String.format("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø²ÙˆØ§Ø± Ø¥Ù„Ù‰ UID: %s Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰<br>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨: %s<br>", uid, playerInfo);
        } else {
            return String.format("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø²ÙˆØ§Ø± Ø¥Ù„Ù‰ UID: %s. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.", uid);
        }
    }
}